from https://hackmd.io/@kochan/r1V5Qjjy5

# Архитектура аналитического хранилища для KION (draft 2)

## Масштабирование
```
- Нагрузка на запись новых событий — 8 000 RPS.
- Нагрузка на чтение — 250 RPS.
- Доступность сервиса — 99,9 %.
```

Для начала, нужно понять как хранить наши данные так, чтобы это горизонтально масштабировалось. Репликация не поможет нам с пропускной способностью по записи, так что бд нужно будет шардировать.

Для хранения данных будем использовать ClickHouse, так как он популярен, в нём встроены функции для масштабирования, и это колоночная БД

Для read-write consistency и кеширования при запросе на сервис, помимо загрузки данных в очеред будем писать данные в redis-кластер. Также при считывании данных мы будем сначала стучаться в redis, потом читать из бд и кешировать в redis

![](https://i.imgur.com/zAP2wNi.png)


## Сервис

Сервис состоит из трёх эндпоинтов:
1. `set <user_id> <event_time> <video_id> <video_time>` -- Действие пользователя когда он переходит на таймкод или смотрит видео до этого момента
    В момент получения set запроса сервис:
    1. Добавляет в свой локальный буфер новую строчку 
    2. Отправляет в redis новую строчку `user_id-video_id:video_time` c expire
    3. Если в буфере набралось размер батча строчек, то он отправляет их в Kafka
3. `get <user_id> <video_id>` -- Возвращает записанное для пользователя время
    1. Стучится в redis, нет ли у него подходящего значения
    2. Если нет, то идёт за ним в клик, и обновляет redis
    3. Отдаёт время


Сервис перекладки берет данные из кафки и инсертит их в Clickhouse

Эндпоинты будут реализованы как gRPC ручки

## Мониторинг

В качестве мониторинга выбрали стек ELK

Подумали какие метрики хочется собирать:
1. Response time сервиса по разным ручкам
2. Все ошибки
3. Rps сервиса
4. cpu load сервиса, перекладки -> увеличивать размеры кластеров, если большой load
5. cpu load Kafka, Clickhouse
6. память Redis, хранилище Clickhouse
7. количество батчей обработанных кластером перекладки / секунду
8. Что-то ещё?


## Фидбек

1. Ок ли давать прямой доступ аналитическому сервису в клик?
2. RabbitMQ или Kafka, вроде кафка быстрее и проще -> подходит нам лучше?


----
Awesome-scalability - доклады из блогов больших компаний: https://github.com/binhnguyennus/awesome-scalability
Designing Data-Intensive Applications